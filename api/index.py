import os
import json
import base64
import re
from flask import Flask, render_template, request, jsonify
from flask_cors import CORS
from openai import OpenAI
from dotenv import load_dotenv
from google.cloud import vision

# í™˜ê²½ ë³€ìˆ˜ ë¡œë“œ
load_dotenv()

# Vercel í™˜ê²½ì—ì„œ templates í´ë” ìœ„ì¹˜ë¥¼ ì •í™•íˆ ì§€ì •
template_dir = os.path.abspath(os.path.join(os.path.dirname(__file__), '..', 'templates'))
app = Flask(__name__, template_folder=template_dir)
CORS(app)

def get_client(api_key=None):
    """OpenAI í´ë¼ì´ì–¸íŠ¸ ë°˜í™˜ (í‚¤ í˜•ì‹ ê²€ì¦)"""
    key = api_key if api_key and api_key.strip() else os.getenv("OPENAI_API_KEY")
    if not key or not str(key).startswith("sk-") or key == "sk-your-api-key-here":
        return None
    try:
        return OpenAI(api_key=key)
    except:
        return None

def extract_menu_google_vision(image_b64):
    """Google Cloud Vision OCR (êµ¬ê¸€ í”„ë¡œì íŠ¸ ID ê¸°ë°˜)"""
    try:
        content = base64.b64decode(image_b64)
        image = vision.Image(content=content)
        client = vision.ImageAnnotatorClient()
        response = client.text_detection(image=image)
        texts = response.text_annotations
        return texts[0].description if texts else ""
    except Exception as e:
        print(f"Google Vision Error: {e}")
        return None

def extract_menu_from_image(openai_client, image_b64):
    """ì´ë¯¸ì§€ ë¶„ì„ (Google OCR + AI ì •ë¦¬)"""
    raw_text = extract_menu_google_vision(image_b64)
    
    if raw_text:
        prompt = f"ì•„ë˜ í…ìŠ¤íŠ¸ì—ì„œ ë‚ ì§œë³„ ì ì‹¬ ë©”ë‰´ë¥¼ ì°¾ì•„ JSON í˜•ì‹ìœ¼ë¡œ ì •ë¦¬í•´ì¤˜.\në‚ ì§œ: MM/DD(ìš”ì¼)\ní…ìŠ¤íŠ¸: {raw_text}\nê²°ê³¼ëŠ” ```json ... ``` ë¸”ë¡ì— ë„£ì–´ì¤˜."
    else:
        prompt = "ì´ë¯¸ì§€ì˜ ê¸‰ì‹í‘œë¥¼ ë¶„ì„í•´ì„œ ë‚ ì§œë³„ ë©”ë‰´ë¥¼ JSONìœ¼ë¡œ ì •ë¦¬í•´ì¤˜. ê²°ê³¼ëŠ” ```json ... ``` ë¸”ë¡ì— ë„£ì–´ì¤˜."

    messages = [{"role": "user", "content": [{"type": "text", "text": prompt}]}]
    if not raw_text:
        messages[0]["content"].append({"type": "image_url", "image_url": {"url": f"data:image/jpeg;base64,{image_b64}"}})

    # 3. ë°ëª¨ ëª¨ë“œ ì²˜ë¦¬ (AI í´ë¼ì´ì–¸íŠ¸ê°€ ì—†ëŠ” ê²½ìš°)
    if not openai_client:
        # ê°„ë‹¨í•œ í…ìŠ¤íŠ¸ ê²€ì¦ ì‹œë®¬ë ˆì´ì…˜
        if raw_text:
            non_menu_keywords = ["êµ¬í•˜ì‹œì˜¤", "ì •ë‹µ", "ë¬¸ì œ", "ì›", "ìˆ˜í•™"]
            if any(k in raw_text for k in non_menu_keywords):
                return {"error": "ê¸‰ì‹í‘œê°€ ì•„ë‹Œ ì´ë¯¸ì§€ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. (ìˆ˜í•™ ë¬¸ì œ ë“±ìœ¼ë¡œ ë³´ì„)"}

        from datetime import datetime, timedelta
        mock_data = {}
        days_ko = ["ì›”", "í™”", "ìˆ˜", "ëª©", "ê¸ˆ", "í† ", "ì¼"]
        for i in range(7):
            date = datetime.now() + timedelta(days=i)
            date_str = date.strftime("%m/%d") + f"({days_ko[date.weekday()]})"
            samples = [
                "ì¹´ë ˆë¼ì´ìŠ¤, ë¯¸ì—­êµ­, ê³„ë€ë§ì´",
                "ë¹„ë¹”ë°¥, ëœì¥ì°Œê°œ, ë–¡ê°ˆë¹„",
                "ëˆê°€ìŠ¤, ìš°ë™, ì–‘ë°°ì¶”ìƒëŸ¬ë“œ",
                "ì œìœ¡ë®ë°¥, ì½©ë‚˜ë¬¼êµ­, ê°ìì±„ë³¶ìŒ",
                "ìƒì„ êµ¬ì´, ìœ¡ê°œì¥, ì‹œê¸ˆì¹˜ë‚˜ë¬¼",
                "ë³¶ìŒë°¥, ì§¬ë½•êµ­, ë‹¨ë¬´ì§€ë¬´ì¹¨",
                "ë¶ˆê³ ê¸°ë®ë°¥, ë§Œë‘êµ­, ê¹€ì¹˜"
            ]
            mock_data[date_str] = samples[i % len(samples)]
        return mock_data

    response = openai_client.chat.completions.create(model="gpt-4o-mini", messages=messages, max_tokens=1000)
    raw = response.choices[0].message.content
    match = re.search(r"```json\s*(.*?)\s*```", raw, re.DOTALL)
    return json.loads(match.group(1)) if match else {}

@app.route('/')
def home():
    return render_template('index.html')

@app.route('/api/config')
def get_config():
    api_key = os.getenv("OPENAI_API_KEY")
    has_key = api_key is not None and str(api_key).startswith("sk-")
    return jsonify({"hasServerKey": has_key, "demoMode": not has_key})

@app.route('/api/analyze', methods=['POST'])
def api_analyze():
    data = request.json
    api_key = data.get('apiKey')
    image_b64 = data.get('image').split(',')[-1] if ',' in data.get('image', '') else data.get('image')
    openai_client = get_client(api_key)
    return jsonify(extract_menu_from_image(openai_client, image_b64))

@app.route('/api/recommend', methods=['POST'])
def api_recommend():
    data = request.json
    lunch = data.get('lunch', '')
    ingredients = data.get('ingredients', '')
    openai_client = get_client(data.get('apiKey'))
    
    if not openai_client:
        import random
        # ë°ëª¨ ëª¨ë“œ ì „ìš© ê³ ì • ë ˆì‹œí”¼ ë¼ì´ë¸ŒëŸ¬ë¦¬ (ì‹¤ì œ ì¡´ì¬í•˜ëŠ” ë©”ë‰´ë“¤)
        RECIPE_LIBRARY = [
            {
                "name": "ë°±ì¢…ì› ê³ ë“±ì–´ ë¬´ì¡°ë¦¼",
                "ingredients": ["ê³ ë“±ì–´", "ë¬´", "ì–‘íŒŒ", "ëŒ€íŒŒ", "ê³ ì¶§ê°€ë£¨", "ê°„ì¥", "ì„¤íƒ•", "ë‹¤ì§„ë§ˆëŠ˜", "ëœì¥"],
                "analysis": "ë¹„ë¦°ë‚´ ì—†ì´ ë§¤ì½¤ë‹¬ì½¤í•œ ë°±ì¢…ì›í‘œ í™©ê¸ˆë ˆì‹œí”¼ ê³ ë“±ì–´ ì¡°ë¦¼ì…ë‹ˆë‹¤.",
                "desc": "ë¬´ì˜ ë‹¬í°í•¨ê³¼ ê³ ë“±ì–´ì˜ ê³ ì†Œí•¨ì´ ì–‘ë…ê³¼ ì–´ìš°ëŸ¬ì§„ ìµœê³ ì˜ ë°¥ë„ë‘‘",
                "time": "35", "diff": "ë³´í†µ",
                "steps": [
                    "ë¬´ëŠ” 1.5cm ë‘ê»˜ë¡œ ë°˜ë‹¬ ì°ì–´ ëƒ„ë¹„ ë°”ë‹¥ì— ê¹ë‹¤",
                    "ì†ì§ˆëœ ê³ ë“±ì–´ë¥¼ ë¬´ ìœ„ì— ì˜¬ë¦¬ê³  ì–‘íŒŒì™€ ëŒ€íŒŒë¥¼ ì–¹ëŠ”ë‹¤",
                    "ë¬¼ 500mlì— ì–‘ë…ì¥(ê³ ì¶§ê°€ë£¨ 3, ê°„ì¥ 5, ì„¤íƒ• 1, ëœì¥ 0.5 ë“±)ì„ í’€ì–´ ë¶“ëŠ”ë‹¤",
                    "ì„¼ ë¶ˆì—ì„œ ë“ì´ë‹¤ê°€ êµ­ë¬¼ì´ ë“ì–´ì˜¤ë¥´ë©´ ì¤‘ë¶ˆë¡œ ì¤„ì—¬ ë¬´ê°€ í‘¹ ìµì„ ë•Œê¹Œì§€ ì¡¸ì¸ë‹¤"
                ],
                "tip": "ëœì¥ ë°˜ í°ìˆ ê³¼ ë“¤ê¸°ë¦„ì„ ë„£ìœ¼ë©´ ìƒì„ ì˜ ë¹„ë¦°ë‚´ë¥¼ ì™„ë²½í•˜ê²Œ ì¡ì„ ìˆ˜ ìˆì–´ìš”",
                "message": "ì…ë§› í™• ë„ëŠ” ì¹¼ì¹¼í•œ ì¡°ë¦¼ìœ¼ë¡œ ì˜¤ëŠ˜ ì €ë… ì–´ë– ì„¸ìš”? ğŸŸ"
            },
            {
                "name": "ë§‘ì€ ì†Œê³ ê¸° ë­‡êµ­",
                "ingredients": ["ì†Œê³ ê¸°", "ë¬´", "ëŒ€íŒŒ", "ì°¸ê¸°ë¦„", "êµ­ê°„ì¥", "ë§ˆëŠ˜"],
                "analysis": "ì•„ì´ë“¤ë„ ì¢‹ì•„í•˜ê³  ì†ì´ í™• í’€ë¦¬ëŠ” ì‹œì›í•˜ê³  ë§‘ì€ ì†Œê³ ê¸° ë­‡êµ­ì…ë‹ˆë‹¤.",
                "desc": "ì˜¤ë˜ ë“ì¼ìˆ˜ë¡ ê³ ê¸°ì—ì„œ ìš°ëŸ¬ë‚˜ëŠ” ê¹Šì€ ë§›ì´ ì¼í’ˆì¸ êµ­ë¬¼ ìš”ë¦¬",
                "time": "30", "diff": "ë³´í†µ",
                "steps": [
                    "ì†Œê³ ê¸°ëŠ” í‚¤ì¹œíƒ€ì›”ë¡œ í•ë¬¼ì„ ë‹¦ê³  ë¬´ëŠ” ë‚˜ë°•ì°ê¸° í•œë‹¤",
                    "ì°¸ê¸°ë¦„ì„ ë‘ë¥¸ ëƒ„ë¹„ì— ì†Œê³ ê¸°ë¥¼ ë¨¼ì € ë³¶ë‹¤ê°€ ê²‰ë©´ì´ ìµìœ¼ë©´ ë¬´ë¥¼ ë„£ê³  íˆ¬ëª…í•´ì§ˆ ë•Œê¹Œì§€ ë³¶ëŠ”ë‹¤",
                    "ë¬¼ì„ ë¶“ê³  ë“ì–´ì˜¤ë¥´ë©´ ìƒê¸°ëŠ” ê±°í’ˆì„ ê¹¨ë—ì´ ê±·ì–´ë‚¸ë‹¤",
                    "êµ­ê°„ì¥ê³¼ ì†Œê¸ˆìœ¼ë¡œ ê°„ì„ ë§ì¶”ê³  ë‹¤ì§„ ë§ˆëŠ˜ê³¼ ëŒ€íŒŒë¥¼ ë„£ì–´ ë§ˆë¬´ë¦¬í•œë‹¤"
                ],
                "tip": "êµ­ê°„ì¥ì„ ë„ˆë¬´ ë§ì´ ë„£ìœ¼ë©´ êµ­ë¬¼ì´ íƒí•´ì§€ë‹ˆ ê°„ì€ ì†Œê¸ˆìœ¼ë¡œ ì¡°ì ˆí•˜ì„¸ìš”",
                "message": "ë”°ëœ»í•˜ê³  ë§‘ì€ êµ­ë¬¼ í•œ ê·¸ë¦‡ìœ¼ë¡œ í”¼ë¡œë¥¼ ë…¹ì—¬ë³´ì„¸ìš”! ğŸ²"
            },
            {
                "name": "ë°±ì¢…ì› ê°ì ì§œê¸€ì´ (ìŠ¤íŒ¸ ì§œê¸€ì´)",
                "ingredients": ["ê°ì", "ìŠ¤íŒ¸", "ì–‘íŒŒ", "ëŒ€íŒŒ", "ê³ ì¶”ì¥", "ê³ ì¶§ê°€ë£¨", "ê°„ì¥", "ì„¤íƒ•"],
                "analysis": "ì¬ë£Œë¥¼ ë‹¤ ë„£ê³  ë“ì´ê¸°ë§Œ í•˜ë©´ ì™„ì„±ë˜ëŠ” ì´ˆê°„ë‹¨ ë°¥ë„ë‘‘ ì§œê¸€ì´ì…ë‹ˆë‹¤.",
                "desc": "ìŠ¤íŒ¸ì„ ìœ¼ê¹¨ ë„£ì–´ êµ­ë¬¼ì˜ ê°ì¹ ë§›ì„ ê·¹ëŒ€í™”í•œ ì–¼í°í•œ ì°Œê°œ",
                "time": "20", "diff": "ì‰¬ì›€",
                "steps": [
                    "ê°ìëŠ” êµµê²Œ ì±„ ì°ê³  ì–‘íŒŒëŠ” ì±„ ì¬ë‹¤",
                    "ìŠ¤íŒ¸ì€ ë¹„ë‹ë´‰ì§€ì— ë„£ì–´ ì…ìê°€ ë³´ì¼ ì •ë„ë¡œ ê±°ì¹ ê²Œ ìœ¼ê¹¬ë‹¤",
                    "ëƒ„ë¹„ì— ëª¨ë“  ì¬ë£Œì™€ ì–‘ë…ì¥(ê³ ì¶”ì¥ 1, ê³ ì¶§ê°€ë£¨ 2, ê°„ì¥ 4, ì„¤íƒ• 1)ì„ ë„£ê³  ë¬¼ 2ì»µì„ ë¶“ëŠ”ë‹¤",
                    "ê°ìê°€ í‘¹ ìµê³  êµ­ë¬¼ì´ ìì‘í•˜ê²Œ ì¤„ì–´ë“¤ ë•Œê¹Œì§€ ì¡¸ì´ë“¯ ë“ì¸ë‹¤"
                ],
                "tip": "ìŠ¤íŒ¸ì„ ì™„ì „íˆ ìœ¼ê¹¨ì•¼ êµ­ë¬¼ì— í–„ì˜ í’ë¯¸ê°€ ì§„í•˜ê²Œ ìš°ëŸ¬ë‚©ë‹ˆë‹¤",
                "message": "ë‹¤ë¥¸ ë°˜ì°¬ í•„ìš” ì—†ì´ ì´ê±° í•˜ë‚˜ë©´ ë°¥ ë‘ ê·¸ë¦‡ ëšë”±! ğŸ”¥"
            },
            {
                "name": "ì•¼ì±„ ë“¬ë¿ ê³„ë€ë§ì´",
                "ingredients": ["ê³„ë€", "ë‹¹ê·¼", "ëŒ€íŒŒ", "íŒŒí”„ë¦¬ì¹´", "ìš°ìœ ", "ì†Œê¸ˆ"],
                "analysis": "ì•Œë¡ë‹¬ë¡í•œ ì±„ì†Œê°€ ë“¬ë¿ ë“¤ì–´ê°€ ì˜ì–‘ë„ ë¹„ì£¼ì–¼ë„ ë§Œì ì¸ ê³„ë€ë§ì´ì…ë‹ˆë‹¤.",
                "desc": "ë¶€ë“œëŸ½ê³  ì´‰ì´‰í•œ ì‹ê°ì„ ì‚´ë¦° ì•„ì´ë“¤ ìµœê³ ì˜ ë°˜ì°¬",
                "time": "15", "diff": "ë³´í†µ",
                "steps": [
                    "ì±„ì†ŒëŠ” ê³„ë€ë§ì´ê°€ í„°ì§€ì§€ ì•Šê²Œ ìµœëŒ€í•œ ì˜ê²Œ ë‹¤ì§„ë‹¤",
                    "ê³„ë€ì— ë‹¤ì§„ ì±„ì†Œ, ìš°ìœ  2í°ìˆ , ì†Œê¸ˆì„ ë„£ê³  ì˜ í’€ì–´ì¤€ë‹¤",
                    "íŒ¬ì— ê¸°ë¦„ì„ ë‘ë¥´ê³  í‚¤ì¹œíƒ€ì›”ë¡œ ì‚´ì§ ë‹¦ì•„ë‚¸ ë’¤ ì•½ë¶ˆì—ì„œ ê³„ë€ë¬¼ì„ ì–‡ê²Œ ë¶“ëŠ”ë‹¤",
                    "ê°€ì¥ìë¦¬ê°€ ìµìœ¼ë©´ ëŒëŒ ë§ì•„ ëìœ¼ë¡œ ë°€ê³  ë‹¤ì‹œ ê³„ë€ë¬¼ì„ ë¶€ìœ¼ë©° ë°˜ë³µí•œë‹¤"
                ],
                "tip": "ìš°ìœ ë¥¼ ì¡°ê¸ˆ ë„£ìœ¼ë©´ í›¨ì”¬ ë¶€ë“œëŸ½ê³ , ë‹¤ ìµì€ í›„ ì‹í˜€ì„œ ì°ì–´ì•¼ ë‹¨ë©´ì´ ì˜ˆë»ìš”",
                "message": "ì •ì„±ì´ ê°€ë“ ë‹´ê¸´ ë…¸ë€ ê³„ë€ë§ì´ë¡œ ì‹íƒì„ í™˜í•˜ê²Œ ë°í˜€ë³´ì„¸ìš”! ğŸ’›"
            },
            {
                "name": "ë§¤ì½¤ ë‘ë¶€ì¡°ë¦¼",
                "ingredients": ["ë‘ë¶€", "ì–‘íŒŒ", "ëŒ€íŒŒ", "ê°„ì¥", "ê³ ì¶§ê°€ë£¨", "ì„¤íƒ•", "ë‹¤ì§„ë§ˆëŠ˜"],
                "analysis": "êµ¬ìš´ ë‘ë¶€ì— ê°ì¹ ë§› ë‚˜ëŠ” ì–‘ë…ì¥ì´ ì™ ë°´ ë“ ë“ í•œ ë°‘ë°˜ì°¬ì…ë‹ˆë‹¤.",
                "desc": "ê²‰ì€ ì«„ê¹ƒí•˜ê³  ì†ì€ ë¶€ë“œëŸ¬ìš´ ì§­ì§¤ ë§¤ì½¤í•œ ë°¥ë°˜ì°¬",
                "time": "20", "diff": "ì‰¬ì›€",
                "steps": [
                    "ë‘ë¶€ëŠ” ë„í†°í•˜ê²Œ ì°ì–´ ì†Œê¸ˆì„ ë¿Œë ¤ ë°‘ê°„í•˜ê³  ë¬¼ê¸°ë¥¼ ì œê±°í•œë‹¤",
                    "íŒ¬ì— ë‘ë¶€ë¥¼ ì•ë’¤ë¡œ ë…¸ë¦‡ë…¸ë¦‡í•˜ê²Œ êµ¬ì›Œ ì™„ì„±ëœ ë§›ì„ ë†’ì¸ë‹¤",
                    "ëƒ„ë¹„ ë°”ë‹¥ì— ì–‘íŒŒë¥¼ ê¹”ê³  êµ¬ìš´ ë‘ë¶€ë¥¼ ì˜¬ë¦° ë’¤ ì–‘ë…ì¥ì„ ê³¨ê³ ë£¨ ë¿Œë¦°ë‹¤",
                    "êµ­ë¬¼ì´ ìì‘í•´ì§ˆ ë•Œê¹Œì§€ ì¤‘ë¶ˆì—ì„œ ì¡°ë ¤ë‚¸ë‹¤"
                ],
                "tip": "ë‘ë¶€ë¥¼ í•œ ë²ˆ êµ¬ì›Œì„œ ì¡°ë¦¬ë©´ ì‹ê°ì´ ë” ë‹¨ë‹¨í•´ì§€ê³  ê³ ì†Œí•´ì§‘ë‹ˆë‹¤",
                "message": "ë“ ë“ í•˜ê³  ë§›ìˆëŠ” ë‘ë¶€ì¡°ë¦¼ìœ¼ë¡œ í’ì„±í•œ ì‹íƒ ë§Œë“œì„¸ìš”! ğŸ±"
            },
            {
                "name": "ë°”ì‚­ ê³ ë“±ì–´ êµ¬ì´",
                "ingredients": ["ê³ ë“±ì–´", "êµµì€ì†Œê¸ˆ", "ì‹ì´ˆ", "ì‹ìš©ìœ ", "ë ˆëª¬"],
                "analysis": "ì§‘ì—ì„œë„ ë¹„ë¦°ë‚´ ì—†ì´ ê²‰ë°”ì†ì´‰í•˜ê²Œ ê³ ë“±ì–´ë¥¼ êµ½ëŠ” ë¹„ë²•ì…ë‹ˆë‹¤.",
                "desc": "ì—ì–´í”„ë¼ì´ì–´ë‚˜ íŒ¬ìœ¼ë¡œ ê°„ë‹¨íˆ ë§Œë“œëŠ” ê³ ì†Œí•œ ìƒì„ êµ¬ì´",
                "time": "15", "diff": "ì‰¬ì›€",
                "steps": [
                    "ê³ ë“±ì–´ëŠ” ìŒ€ëœ¨ë¬¼ì— ì”»ì–´ ë¬¼ê¸°ë¥¼ ì™„ì „íˆ ë‹¦ê³  ì‹ì´ˆë¥¼ ì‚´ì§ ë°”ë¥¸ë‹¤",
                    "íŒ¬ì— ê¸°ë¦„ì„ ë‘ë¥´ê³  ë‹¬êµ° ë’¤ ê»ì§ˆ ë¶€ë¶„ë¶€í„° êµ½ê¸° ì‹œì‘í•œë‹¤",
                    "ë’¤ì§‘ì–´ì„œ ë…¸ë¦‡í•˜ê²Œ ìµíŒ ë’¤ ë ˆëª¬ì¦™ì„ ë¿Œë ¤ ë§ˆë¬´ë¦¬í•œë‹¤"
                ],
                "tip": "êµ½ê¸° ì „ ì‹ì´ˆë¥¼ ì‚´ì§ ë°”ë¥´ë©´ ë¹„ë¦°ë‚´ê°€ ë‚ ì•„ê°€ê³  ì‚´ì´ ë‹¨ë‹¨í•´ì§‘ë‹ˆë‹¤",
                "message": "ê³ ì†Œí•œ ëƒ„ìƒˆ ê°€ë“! ë‹¨ë°±ì§ˆ í’ë¶€í•œ ì˜ì–‘ ì‹íƒ ë˜ì„¸ìš”! âœ¨"
            },
            {
                "name": "í¬ìŠ¬í¬ìŠ¬ ê°ìì±„ ë³¶ìŒ",
                "ingredients": ["ê°ì", "ì–‘íŒŒ", "í–„", "íŒŒí”„ë¦¬ì¹´", "ì†Œê¸ˆ", "í›„ì¶”"],
                "analysis": "ê°ìì˜ ì „ë¶„ì„ ë¹¼ì„œ ì•„ì‚­í•˜ê³  ê¹”ë”í•˜ê²Œ ë³¶ì•„ë‚¸ êµ­ë¯¼ ë°˜ì°¬ì…ë‹ˆë‹¤.",
                "desc": "ë¶€ì„œì§€ì§€ ì•Šê³  ê²°ì´ ì‚´ì•„ìˆëŠ” í¬ìŠ¬í¬ìŠ¬í•œ ê°ì ë³¶ìŒ",
                "time": "15", "diff": "ì‰¬ì›€",
                "steps": [
                    "ê°ìëŠ” ì±„ ì¬ í›„ ì°¬ë¬¼ì— 5~10ë¶„ê°„ ë‹´ê°€ ì „ë¶„ê¸°ë¥¼ í™•ì‹¤íˆ ëº€ë‹¤",
                    "íŒ¬ì— ì‹ìš©ìœ ë¥¼ ë‘ë¥´ê³  ê°ìì±„ë¥¼ ë¨¼ì € ë³¶ë‹¤ê°€ íˆ¬ëª…í•´ì§€ë©´ ì–‘íŒŒì™€ í–„ì„ ë„£ëŠ”ë‹¤",
                    "ì†Œê¸ˆê³¼ í›„ì¶”ë¡œ ê°„ì„ í•˜ê³  ë§ˆì§€ë§‰ì— í†µê¹¨ë¥¼ ë¿Œë¦°ë‹¤"
                ],
                "tip": "ê°ìë¥¼ ë³¶ê¸° ì „ ë“ëŠ” ë¬¼ì— 1ë¶„ ì •ë„ ì‚´ì§ ë°ì¹˜ë©´ íƒ€ì§€ ì•Šê³  ê³¨ê³ ë£¨ ìµì–´ìš”",
                "message": "ì•„ì‚­ì•„ì‚­ ì”¹ëŠ” ì¬ë¯¸ê°€ ìˆëŠ” ê°ìì±„ ë³¶ìŒ ì–´ë– ì‹ ê°€ìš”? ğŸ¥”"
            },
            {
                "name": "ì•„ì‚­ ìƒˆì½¤ë‹¬ì½¤ ë¬´ìƒì±„",
                "ingredients": ["ë¬´", "ê³ ì¶§ê°€ë£¨", "ì‹ì´ˆ", "ì„¤íƒ•", "ë©¸ì¹˜ì•¡ì “", "ë‹¤ì§„ë§ˆëŠ˜"],
                "analysis": "ì…ë§› ì—†ì„ ë•Œ ë°¥ì— ìŠ¥ìŠ¥ ë¹„ë²¼ ë¨¹ê¸° ì¢‹ì€ ì¦‰ì„ ë¬´ìƒì±„ì…ë‹ˆë‹¤.",
                "desc": "ì ˆì´ì§€ ì•Šê³  ë°”ë¡œ ë²„ë¬´ë ¤ ì•„ì‚­í•¨ì´ ì‚´ì•„ìˆëŠ” ìƒí¼í•œ ë°˜ì°¬",
                "time": "10", "diff": "ë§¤ìš° ì‰¬ì›€",
                "steps": [
                    "ë¬´ëŠ” 0.3cm ë‘ê»˜ë¡œ ì¼ì •í•˜ê²Œ ì±„ ì¬ë‹¤",
                    "ì±„ ì¬ ë¬´ì— ê³ ì¶§ê°€ë£¨ë¥¼ ë¨¼ì € ë„£ê³  ë²„ë¬´ë ¤ ìƒ‰ì„ ì…íŒë‹¤",
                    "ë‚˜ë¨¸ì§€ ì–‘ë…(ì‹ì´ˆ 2, ì„¤íƒ• 2, ì•¡ì “ 1 ë“±)ì„ ë„£ê³  ì¡°ë¬¼ì¡°ë¬¼ ë¬´ì¹œë‹¤"
                ],
                "tip": "ê³ ì¶§ê°€ë£¨ë¥¼ ë¨¼ì € ë²„ë¬´ë ¤ì•¼ ë¬´ì— ìƒ‰ì´ ì˜ˆì˜ê²Œ ì…í˜€ì§‘ë‹ˆë‹¤",
                "message": "ìƒí¼í•œ ë¬´ìƒì±„ë¡œ ì‹ìš•ì„ ë‹ì›Œë³´ì„¸ìš”! ğŸ¥¬"
            },
            {
                "name": "ë‘ë¶€ ê¹€ì¹˜ ë³¶ìŒ",
                "ingredients": ["ë‘ë¶€", "ê¹€ì¹˜", "ë¼ì§€ê³ ê¸°", "ì–‘íŒŒ", "ì„¤íƒ•", "ì°¸ê¸°ë¦„"],
                "analysis": "ë§¤ì½¤í•˜ê²Œ ë³¶ì€ ë¼ì§€ê¹€ì¹˜ì™€ ë‹´ë°±í•œ ë‘ë¶€ì˜ ì°°ë–¡ê¶í•© ë©”ë‰´ì…ë‹ˆë‹¤.",
                "desc": "ì•ˆì£¼ë¡œë„, ë°˜ë‹´ìœ¼ë¡œë„ ìµœê³ ì¸ ì¸ê¸° ë§Œì  ì¼í’ˆ ìš”ë¦¬",
                "time": "25", "diff": "ë³´í†µ",
                "steps": [
                    "ê¹€ì¹˜ëŠ” ë¨¹ê¸° ì¢‹ê²Œ ì°ê³  ë¼ì§€ê³ ê¸°ë„ í•œì… í¬ê¸°ë¡œ ì¤€ë¹„í•œë‹¤",
                    "íŒ¬ì— ê³ ê¸°ë¥¼ ë¨¼ì € ë³¶ë‹¤ê°€ ê¹€ì¹˜ì™€ ì–‘íŒŒ, ì„¤íƒ•ì„ ë„£ê³  ì¶©ë¶„íˆ ë³¶ëŠ”ë‹¤",
                    "ë‘ë¶€ëŠ” ë“ëŠ” ë¬¼ì— ì‚´ì§ ë°ì³ ë”°ëœ»í•˜ê²Œ ì¤€ë¹„í•œ ë’¤ ë¨¹ê¸° ì¢‹ê²Œ ì¬ë‹¤",
                    "ì ‘ì‹œì— ë‘ë¶€ì™€ ê¹€ì¹˜ë¥¼ ì˜ˆì˜ê²Œ ë‘˜ëŸ¬ ë‹´ì•„ ì™„ì„±í•œë‹¤"
                ],
                "tip": "ê¹€ì¹˜ë¥¼ ë³¶ì„ ë•Œ ì„¤íƒ•ì„ ì¡°ê¸ˆ ë„£ìœ¼ë©´ ë§›ì´ í›¨ì”¬ ë¶€ë“œëŸ¬ì›Œì§‘ë‹ˆë‹¤",
                "message": "ë“ ë“ í•˜ê³  ê·¼ì‚¬í•œ í•œ ë¼, ë‘ë¶€ ê¹€ì¹˜ë¡œ í•´ê²°í•´ ë³´ì„¸ìš”! ğŸ”¥"
            }
        ]
        
        click_count = data.get('clickCount', 0)
        ing_list = [i.strip() for i in ingredients.replace(',', ' ').replace('/', ' ').split() if i.strip()]
        
        matches = []
        is_fallback = False

        if ing_list:
            for r in RECIPE_LIBRARY:
                score = 0
                for user_ing in ing_list:
                    # ì—„ê²©í•œ ë§¤ì¹­: 1ê¸€ìë©´ ì™„ì „ ì¼ì¹˜, 2ê¸€ì ì´ìƒì´ë©´ ë¶€ë¶„ ì¼ì¹˜
                    found_in_ings = any((user_ing == ri if len(user_ing) == 1 else user_ing in ri) for ri in r['ingredients'])
                    found_in_name = (user_ing == r['name'] if len(user_ing) == 1 else user_ing in r['name'])
                    
                    if found_in_ings: score += 2
                    if found_in_name: score += 1

                if score > 0:
                    matches.append((score, r))
            
            if matches:
                matches.sort(key=lambda x: x[0], reverse=True)
                results = [m[1] for m in matches]
            else:
                # [ìˆ˜ì •] ì¬ë£Œì— ë§ëŠ” ë ˆì‹œí”¼ê°€ ì—†ìœ¼ë©´ ë ˆì‹œí”¼ ì¹´ë“œ ì—†ì´ 'ë©”ë‰´ ì¶”ì²œ'ë§Œ ìˆ˜í–‰
                available_menus = ", ".join([str(r['name']) for r in RECIPE_LIBRARY])
                return jsonify({
                    "analysis": f"ì…ë ¥í•˜ì‹  ì¬ë£Œ({', '.join([str(i) for i in ing_list])})ì™€ ë§¤ì¹­ë˜ëŠ” ìƒì„¸ ë ˆì‹œí”¼ë¥¼ ë°ëª¨ ë°ì´í„°ì—ì„œ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.",
                    "recipes": [],
                    "message": f"ëŒ€ì‹  ì´ëŸ° ë©”ë‰´ë“¤ì€ ì–´ë– ì„¸ìš”? âœ¨\n[{available_menus}]\n\n*ì‹¤ì œ AI ë²„ì „ì€ ì–´ë–¤ ì¬ë£Œë“  ì‹¤ì‹œê°„ìœ¼ë¡œ ë ˆì‹œí”¼ë¥¼ ìƒì„±í•´ ë“œë¦½ë‹ˆë‹¤!*"
                })
        else:
            # ì…ë ¥ ì¬ë£Œê°€ ì•„ì˜ˆ ì—†ëŠ” ê²½ìš°ì—ë§Œ ì „ì²´ ë¼ì´ë¸ŒëŸ¬ë¦¬ ìˆœí™˜
            results = RECIPE_LIBRARY.copy()
            random.shuffle(results)

        # íšŸìˆ˜ ì†Œì§„ ì²˜ë¦¬
        if click_count >= len(results):
            return jsonify({
                "analysis": "í˜„ì¬ ì¤€ë¹„ëœ ëª¨ë“  ë°ëª¨ ë©”ë‰´ë¥¼ í™•ì¸í•˜ì…¨ìŠµë‹ˆë‹¤.",
                "recipes": [],
                "message": "ì´ˆê¸°í™” ë²„íŠ¼ì„ ëˆŒëŸ¬ ì²˜ìŒë¶€í„° ë‹¤ì‹œ ë³´ê±°ë‚˜ ë‹¤ë¥¸ ì¬ë£Œë¥¼ ì…ë ¥í•´ ë³´ì„¸ìš”! ğŸ˜Š"
            })

        chosen = results[click_count]
        
        return jsonify({
            "analysis": str(chosen['analysis']),
            "recipes": [chosen],
            "message": str(chosen['message'])
        })

    # ì‹¤ì œ AI ì¶”ì²œ ë¡œì§
    prompt = f"""[ìƒí™©] ì˜¤ëŠ˜ ì•„ì´ ì ì‹¬: {lunch}, ëƒ‰ì¥ê³  ì¬ë£Œ: {ingredients}. ì ì‹¬ê³¼ ê²¹ì¹˜ì§€ ì•ŠëŠ” ì €ë… ë©”ë‰´ 2ê°œì™€ ë ˆì‹œí”¼, ê·¸ë¦¬ê³  ì§€ì¹œ ë¶€ëª¨ë‹˜ì„ ìœ„í•œ ë§ì¶¤í˜• ì‘ì› ë©˜íŠ¸ë¥¼ JSONìœ¼ë¡œ ì‘ì„±í•´ì¤˜."""
    response = openai_client.chat.completions.create(
        model="gpt-4o-mini",
        messages=[{"role": "system", "content": "ê³µê° ëŠ¥ë ¥ì´ ë›°ì–´ë‚œ ìš”ë¦¬ ì „ë¬¸ê°€ì…ë‹ˆë‹¤."}, {"role": "user", "content": prompt}],
        response_format={"type": "json_object"}
    )
    return jsonify(json.loads(response.choices[0].message.content))

# Vercelì„ ìœ„í•œ í•¸ë“¤ëŸ¬
app = app
